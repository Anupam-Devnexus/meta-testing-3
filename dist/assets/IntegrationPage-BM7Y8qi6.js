import{j as e,d as A,s as T,t as $,v as N}from"./index-ePZmuw5s.js";import{r}from"./react-DNgDP3D6.js";const D=({buttonText:n,buttonColor:i,onClick:s,isLoading:t})=>e.jsx("div",{className:" flex flex-col justify-between",children:e.jsx("button",{onClick:t?void 0:s,disabled:t,className:`mt-4 cursor-pointer px-2 w-full py-2 text-white rounded-lg flex items-center justify-center ${i} ${t?"opacity-70 cursor-not-allowed":""}`,children:t?e.jsx("span",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"}):n})}),U=n=>new Promise((i,s)=>{if(console.log("[FB API] 📡 Fetching pages for user..."),console.log("Using Access Token:",n),!n){s({message:"Access token is required"});return}window.FB.api("/me/accounts","GET",{access_token:n},t=>{!t||t.error?(console.error("[FB API] ❌ Failed to fetch pages:",t?.error),s(t?.error||{message:"Unknown error fetching pages"})):(console.log("[FB API] ✅ Pages fetched successfully:",t.data),i(t.data))})}),K=n=>{const[i,s]=r.useState(!1),[t,l]=r.useState(null);return r.useEffect(()=>{if(window.FB){s(!0);return}if(window.fbAsyncInit=function(){try{window.FB.init({appId:n,cookie:!0,xfbml:!1,version:"v19.0"}),s(!0)}catch(c){l(c.message)}},!document.getElementById("facebook-jssdk")){const c=document.createElement("script");c.id="facebook-jssdk",c.src="https://connect.facebook.net/en_US/sdk.js",c.async=!0,c.defer=!0,c.onerror=()=>l("Failed to load Facebook SDK"),document.body.appendChild(c)}},[n]),{isReady:i,loadError:t}},G=()=>{const{isReady:n,loadError:i}=K("1312250540909733"),[s,t]=r.useState(localStorage.getItem("fb_connected")||"false"),[l,c]=r.useState(null),[k,w]=r.useState([]),[F,g]=r.useState(null),[y,b]=r.useState({}),[h,u]=r.useState(!1),[x,p]=r.useState(!1);r.useEffect(()=>{if(s==="true"&&n){const a=localStorage.getItem("fb_user_token");a?_(a):(localStorage.setItem("fb_connected","false"),t("false"))}},[s,n]);const v=r.useCallback(()=>{if(!n){g("Facebook SDK not loaded yet");return}u(!0),g(null),window.FB.getLoginStatus(a=>{if(a.status==="connected"){const{accessToken:o}=a.authResponse;localStorage.setItem("fb_user_token",o),localStorage.setItem("fb_connected","true"),t("true"),_(o).finally(()=>u(!1));return}window.FB.login(o=>{if(!o.authResponse){g("Login cancelled or failed"),u(!1);return}const{accessToken:m}=o.authResponse;localStorage.setItem("fb_user_token",m),localStorage.setItem("fb_connected","true"),t("true"),_(m).finally(()=>u(!1))},{scope:"public_profile,email,pages_show_list,pages_read_engagement,pages_manage_posts,leads_retrieval,business_management,ads_read",auth_type:"rerequest",return_scopes:!0})})},[n]),_=async a=>{try{const o=await U(a);w(o),o.length>0&&c(o[0])}catch(o){g(o?.message||"Failed to fetch pages")}},C=()=>{n&&window.FB.logout(()=>{localStorage.removeItem("fb_user_token"),localStorage.setItem("fb_connected","false"),t("false"),c(null),w([]),b({})})},E=async()=>{if(!l)return;p(!0);const{id:a,access_token:o}=l,m=["page_impressions","page_engaged_users","page_fan_adds","page_fan_removes","page_views_login_total","page_posts_impressions_organic","page_posts_impressions_paid"],j=[];for(const d of m)try{const I=await new Promise((B,R)=>{window.FB.api(`/${a}/insights`,"GET",{metric:d,access_token:o},f=>f&&!f.error?B(f.data):R(f?.error))});I?.length&&j.push(...I)}catch{}if(!j.length)return p(!1),b({});const S={};j.forEach(d=>{d.values?.length&&(S[d.name]=d.values[0].value??0)}),b(S),localStorage.setItem("fb_connected","true"),p(!1)},P=[{id:1,name:"Facebook",icon:A,bgColor:"bg-blue-50",textColor:"text-blue-800",borderColor:"border-blue-200",buttonText:h?"Connecting...":s==="true"?l?`Connected to ${l.name}`:"Connected":"Connect Facebook",buttonColor:s==="true"?"bg-green-600":"bg-blue-600",onClick:s==="true"?C:v,status:s,loading:h}];return e.jsxs("div",{className:"grid gap-5 p-2 sm:p-4",children:[(F||i)&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-center",children:[e.jsx(T,{className:"text-red-500 mr-3 text-lg"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-red-800 font-semibold",children:"Facebook Error"}),e.jsx("p",{className:"text-red-600 text-sm",children:F||i})]})]}),s==="true"&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 flex items-center transition-all duration-300",children:[e.jsx($,{className:"text-green-500 mr-3 text-lg"}),e.jsxs("p",{className:"text-green-800 font-medium",children:["Connected ",l?`to ${l.name}`:"to Facebook"]})]}),P.map(a=>e.jsx(D,{...a,isConnected:s==="true"},a.id)),h&&e.jsxs("div",{className:"flex justify-center items-center mt-3 text-blue-600",children:[e.jsx(N,{className:"animate-spin mr-2"}),e.jsx("span",{children:"Connecting to Facebook..."})]}),k.length>0&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm p-5 mt-4 transition-all duration-300",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3 text-lg",children:"Your Facebook Pages"}),e.jsx("ul",{className:"list-disc ml-6 space-y-1 text-gray-700",children:k.map(a=>e.jsxs("li",{children:[e.jsx("strong",{children:a.name})," — ID: ",a.id]},a.id))}),l&&e.jsx("button",{onClick:E,disabled:x,className:`mt-4 px-5 py-2 rounded-md shadow transition-all duration-200 ${x?"bg-indigo-400 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-700 text-white"}`,children:x?e.jsxs("span",{className:"flex items-center",children:[e.jsx(N,{className:"animate-spin mr-2"})," Fetching Insights..."]}):`Fetch Insights for ${l.name}`})]}),Object.keys(y).length>0&&e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-xl p-5 mt-4 shadow-inner transition-all duration-300",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3 text-lg",children:"Page Insights"}),e.jsx("pre",{className:"text-xs bg-gray-100 p-3 rounded-lg overflow-auto text-gray-700",children:JSON.stringify(y,null,2)})]})]})};export{G as default};

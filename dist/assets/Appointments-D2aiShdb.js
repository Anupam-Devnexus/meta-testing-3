import{a as T,j as n}from"./index-ePZmuw5s.js";import{r as a}from"./react-DNgDP3D6.js";import{F as P,i as z,a as K}from"./fullcalendar-CfNvoZTh.js";import{y as g}from"./index-zxlf4DXA.js";import"./charts-CZ9u0xu3.js";const Z="490637615992-dj2b00g9hd3k58kde1e597nnnvtjjaj6.apps.googleusercontent.com",q="AIzaSyC8HRFwH9Ss-mWN3_8iuQi3KW8PTV5BdZw",V="https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",H="https://dbbackend.devnexussolutions.com/auth/google",J="https://dbbackend.devnexussolutions.com/auth/api/appointment",te=()=>{console.log("[App] Render start");const[p,h]=a.useState(null),[u,x]=a.useState(!1),[S,f]=a.useState([]),[N,I]=a.useState(!1),[j,C]=a.useState(!1),[E,v]=a.useState(!1),[m,k]=a.useState(""),[i,c]=a.useState({title:"",description:"",date:"",startTime:"09:00",endTime:"10:00",attendees:[""]}),y=a.useRef(null),o=(e,t,s=null)=>{console.error(`[${e}] ${t}`,s||""),g.error(t)};a.useEffect(()=>{console.log("[Init] Loading gapi & GIS scripts...");const e=document.createElement("script");e.src="https://apis.google.com/js/api.js",e.onload=()=>{console.log("[Init] gapi loaded"),gapi.load("client",A)},e.onerror=()=>o("Init","Failed to load gapi script"),document.body.appendChild(e);const t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",t.async=!0,t.defer=!0,t.onload=D,t.onerror=()=>o("Init","Failed to load GIS script"),document.body.appendChild(t)},[]);const A=a.useCallback(async()=>{console.log("[Init] Initializing gapi client...");try{await gapi.client.init({apiKey:q,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]}),console.log("[Init] gapi client ready"),C(!0)}catch(e){o("Init","Failed to init gapi",e)}},[]),D=a.useCallback(()=>{if(console.log("[Init] Initializing GIS token client..."),!window.google)return o("Init","GIS not available yet");try{y.current=google.accounts.oauth2.initTokenClient({client_id:Z,scope:V,callback:L,error_callback:e=>o("Auth","Token client error",e)}),console.log("[Init] GIS token client initialized")}catch(e){o("Init","Failed to initialize GIS token client",e)}},[]),L=a.useCallback(async e=>{if(console.log("[Auth] Token response received:",e),!e?.access_token)return o("Auth","No access token received");const t=e.access_token;localStorage.setItem("accessToken",t),x(!0),await U(t),b(t);try{await T.post(H,{token:t}),console.log("[Backend] Token sent successfully"),g.success("Logged in successfully!")}catch(s){o("Backend","Backend auth failed",s)}},[]),U=a.useCallback(async e=>{console.log("[User] Fetching user profile...");try{const t=await T.get("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${e}`}}),s={name:t.data.name,email:t.data.email,image:t.data.picture};h(s),localStorage.setItem("userDetails",JSON.stringify(s)),console.log("[User] Profile fetched:",s)}catch(t){o("User","Failed to fetch profile",t)}},[]),R=()=>{if(console.log("[Auth] Login clicked"),!y.current)return o("Auth","Token client not initialized");y.current.requestAccessToken({prompt:"consent"}),console.log("[Auth] Requesting token...")},F=()=>{console.log("[Auth] Logging out...");const e=localStorage.getItem("accessToken");e&&google.accounts.oauth2.revoke(e,()=>console.log("[Auth] Token revoked")),localStorage.removeItem("accessToken"),localStorage.removeItem("userDetails"),h(null),x(!1),f([]),k(""),console.log("[Auth] User logged out"),g.info("Logged out")},b=a.useCallback(async(e=localStorage.getItem("accessToken"))=>{if(console.log("[Events] Fetching events..."),!e)return o("Events","No access token");try{gapi.client.setToken({access_token:e});const t=await gapi.client.calendar.events.list({calendarId:"primary",timeMin:new Date().toISOString(),showDeleted:!1,singleEvents:!0,maxResults:50,orderBy:"startTime"});console.log("[Events] Raw events:",t.result.items);const s=t.result.items.map(l=>({id:l.id,title:l.summary||"No Title",start:l.start.dateTime||l.start.date,end:l.end.dateTime||l.end.date}));f(s),console.log("[Events] Mapped events:",s)}catch(t){o("Events","Failed to fetch events",t)}},[]);a.useEffect(()=>{console.log("[App] Restoring session...");const e=localStorage.getItem("userDetails"),t=localStorage.getItem("accessToken");e&&t&&j&&(h(JSON.parse(e)),x(!0),b(t),console.log("[App] Session restored",e))},[j,b]);const _=e=>{if(console.log("[UI] Date clicked:",e.dateStr),!u)return g.info("Please login first");c(t=>({...t,date:e.dateStr})),v(!0),k("")},$=()=>{console.log("[UI] Adding attendee"),c(e=>({...e,attendees:[...e.attendees,""]}))},G=(e,t)=>{console.log(`[UI] Attendee ${e} changed to: ${t}`),c(s=>{const l=[...s.attendees];return l[e]=t,{...s,attendees:l}})},M=e=>{console.log(`[UI] Removing attendee ${e}`),c(t=>({...t,attendees:t.attendees.filter((s,l)=>l!==e)}))},B=async()=>{if(console.log("[Event] Creating meeting..."),!u)return o("Event","Not signed in");I(!0);try{const e=localStorage.getItem("accessToken"),t=new Date(`${i.date}T${i.startTime}`).toISOString(),s=new Date(`${i.date}T${i.endTime}`).toISOString(),l={summary:i.title||"Untitled Meeting",description:i.description,start:{dateTime:t,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},end:{dateTime:s,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},attendees:i.attendees.filter(r=>r.trim()!=="").map(r=>({email:r})),conferenceData:{createRequest:{requestId:String(Date.now()),conferenceSolutionKey:{type:"hangoutsMeet"}}}};console.log("[Event] Event payload:",l),gapi.client.setToken({access_token:e});const d=await gapi.client.calendar.events.insert({calendarId:"primary",resource:l,conferenceDataVersion:1,sendUpdates:"all"});console.log("[Event] Event created in Google Calendar:",d.result);const w=d.result.conferenceData?.entryPoints?.[0]?.uri||"";k(w),console.log("[Event] Meet link:",w);try{const r=i.attendees.filter(O=>O.trim()!=="");await T.post(J,{event:{...l,meetLink:w,gcalId:d.result.id,attendees:r}}),console.log("[Backend] Event posted and emails sent successfully"),g.success("Event posted and emails sent successfully!")}catch(r){o("Backend","Failed to post event or send emails",r)}f(r=>[...r,{id:d.result.id,title:d.result.summary,start:d.result.start.dateTime,end:d.result.end.dateTime}]),v(!1),c({title:"",description:"",date:"",startTime:"09:00",endTime:"10:00",attendees:[""]})}catch(e){o("Event","Failed to create meeting",e)}finally{I(!1)}};return console.log("[App] Rendering..."),n.jsxs("div",{className:"p-4 max-w-5xl mx-auto",children:[n.jsxs("div",{className:"flex justify-between items-center mb-6",children:[n.jsx("h1",{className:"text-2xl font-bold",children:"Appointments"}),u?n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("img",{src:p?.image,alt:"profile",className:"w-10 h-10 rounded-full border"}),n.jsxs("div",{children:[n.jsx("p",{children:p?.name}),n.jsx("p",{className:"text-sm text-gray-500",children:p?.email})]}),n.jsx("button",{onClick:F,className:"px-3 py-1 bg-red-500 text-white rounded-lg",children:"Logout"})]}):n.jsx("button",{onClick:R,className:"px-4 py-2 bg-blue-600 text-white rounded-lg",children:"Login with Google"})]}),n.jsxs("div",{className:"relative",children:[n.jsx(P,{plugins:[z,K],initialView:"dayGridMonth",events:S,dateClick:_,eventClick:e=>{console.log("[UI] Event clicked:",e.event),g.info(`Event: ${e.event.title}`)},height:"80vh"}),!u&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/70 backdrop-blur-sm rounded",children:n.jsx("p",{children:"Please login to schedule meetings"})})]}),E&&n.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-20 bg-black/50",children:n.jsxs("div",{className:"bg-white rounded-lg w-96 p-6 shadow-lg",children:[n.jsxs("h2",{className:"text-xl font-semibold mb-4",children:["Create Meeting on ",i.date]}),n.jsx("input",{type:"text",placeholder:"Title",value:i.title,onChange:e=>c(t=>({...t,title:e.target.value})),className:"border p-2 rounded w-full mb-2"}),n.jsx("textarea",{placeholder:"Description",value:i.description,onChange:e=>c(t=>({...t,description:e.target.value})),className:"border p-2 rounded w-full mb-2"}),n.jsxs("div",{className:"flex gap-2 mb-2",children:[n.jsx("input",{type:"time",value:i.startTime,onChange:e=>c(t=>({...t,startTime:e.target.value})),className:"border p-2 rounded w-1/2"}),n.jsx("input",{type:"time",value:i.endTime,onChange:e=>c(t=>({...t,endTime:e.target.value})),className:"border p-2 rounded w-1/2"})]}),n.jsxs("div",{className:"mb-2",children:[n.jsx("p",{className:"font-medium",children:"Attendees:"}),i.attendees.map((e,t)=>n.jsxs("div",{className:"flex gap-2 mb-1",children:[n.jsx("input",{type:"email",placeholder:"Email",value:e,onChange:s=>G(t,s.target.value),className:"border p-2 rounded flex-1"}),t>0&&n.jsx("button",{onClick:()=>M(t),className:"text-red-500",children:"âœ•"})]},t)),n.jsx("button",{onClick:$,className:"text-sm text-blue-600 mt-1",children:"+ Add attendee"})]}),m&&n.jsxs("div",{className:"mb-2 p-2 bg-green-100 rounded text-green-800 text-sm",children:["Meet Link: ",n.jsx("a",{href:m,target:"_blank",rel:"noopener noreferrer",className:"underline",children:m}),n.jsx("button",{onClick:()=>navigator.clipboard.writeText(m),className:"ml-2 px-2 py-1 bg-green-600 text-white rounded text-xs",children:"Copy"})]}),n.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[n.jsx("button",{onClick:()=>v(!1),className:"px-3 py-1 bg-gray-300 rounded",children:"Cancel"}),n.jsx("button",{onClick:B,className:"px-3 py-1 bg-green-600 text-white rounded",children:N?"Creating...":"Create"})]})]})})]})};export{te as default};
